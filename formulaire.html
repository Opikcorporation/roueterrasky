<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription au Jeu</title>
    <style>
        body{margin:0;padding:20px;box-sizing:border-box;font-family:"Avenir Book","Avenir",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";background-color:#f5f5f7;color:#1d1d1f;display:flex;justify-content:center;align-items:center;min-height:100vh}.form-container{background-color:#fff;border:1px solid #d2d2d7;box-shadow:0 8px 32px rgba(0,0,0,.08);padding:40px 50px;border-radius:18px;width:100%;max-width:400px;text-align:center}.form-container h1{font-size:28px;font-weight:900;text-transform:uppercase;margin-top:0;margin-bottom:35px;letter-spacing:1px}.input-group{margin-bottom:20px;text-align:left}.input-group label{display:block;margin-bottom:8px;font-weight:400;color:#86868b;font-size:14px}.input-group input{width:100%;padding:12px 15px;background-color:#f5f5f7;border:1px solid #d2d2d7;border-radius:10px;color:#1d1d1f;font-size:16px;box-sizing:border-box;transition:border-color .2s ease,box-shadow .2s ease;font-family:inherit}.input-group input:focus{outline:0;border-color:#007aff;box-shadow:0 0 0 3px rgba(0,122,255,.2)}.submit-button{width:100%;padding:14px;font-size:17px;font-weight:600;color:#fff;background-color:#000;border:none;border-radius:10px;cursor:pointer;transition:background-color .2s ease-in-out;margin-top:15px}.submit-button:hover{background-color:#333}.submit-button:disabled{background-color:#d2d2d7;cursor:not-allowed}.message{margin-top:20px;font-weight:400;font-size:14px;min-height:20px}.message.success{color:#2e7d32}.message.error{color:#d32f2f}
    </style>
</head>
<body>
    <div class="form-container">
        <h1>INSCRIPTION AU JEU</h1>
        <form id="inscription-form">
            <div class="input-group">
                <label for="fullname">Nom & Prénom</label>
                <input type="text" id="fullname" required>
            </div>
            <div class="input-group">
                <label for="pseudo">Pseudo</label>
                <input type="text" id="pseudo" required>
            </div>
            <div class="input-group">
                <label for="whatsapp">Numéro WhatsApp</label>
                <input type="tel" id="whatsapp" required>
            </div>
            <button type="submit" class="submit-button">S'INSCRIRE</button>
        </form>
        <div id="message-area" class="message"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      const firebaseConfig = {
        apiKey: "AIzaSyD_HpLVSSbWJcsvEJVydcpQXy-83YqFZL8",
        authDomain: "roue-de-la-chance-c0f6a.firebaseapp.com",
        projectId: "roue-de-la-chance-c0f6a",
        storageBucket: "roue-de-la-chance-c0f6a.appspot.com",
        messagingSenderId: "491916732335",
        appId: "1:491916732335:web:7a9765b2720d995583315a"
      };
      const app = initializeApp(firebaseConfig);
      window.db = getFirestore(app);
      window.firestoreFunctions = { collection, addDoc, getDocs, query, where };
    </script>

    <script>
        const form = document.getElementById('inscription-form');
        const fullnameInput = document.getElementById('fullname');
        const pseudoInput = document.getElementById('pseudo');
        const whatsappInput = document.getElementById('whatsapp');
        const messageArea = document.getElementById('message-area');
        const submitButton = document.querySelector('.submit-button');

        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');

        console.log("URL Actuelle:", window.location.href);
        console.log("Session ID Trouvé:", sessionId);

        if (!sessionId) {
            document.querySelector('.form-container').innerHTML = '<h1>Lien d\'invitation invalide</h1><p>Aucun ID de session n\'a été trouvé dans l\'URL.</p>';
        }

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            const { db, firestoreFunctions } = window;
            const fullname = fullnameInput.value.trim();
            const pseudo = pseudoInput.value.trim();
            const whatsapp = whatsappInput.value.trim();
            
            messageArea.textContent = '';
            messageArea.className = 'message';
            
            if (!fullname || !pseudo || !whatsapp) {
                displayMessage("Veuillez remplir tous les champs.", "error");
                return;
            }

            submitButton.textContent = 'VÉRIFICATION...';
            submitButton.disabled = true;

            try {
                const participantsRef = firestoreFunctions.collection(db, "sessions", sessionId, "participants");
                const q = firestoreFunctions.query(participantsRef, firestoreFunctions.where("pseudo_lower", "==", pseudo.toLowerCase()));
                const querySnapshot = await firestoreFunctions.getDocs(q);

                if (!querySnapshot.empty) {
                    displayMessage("Ce pseudo est déjà utilisé.", "error");
                    submitButton.textContent = "S'INSCRIRE";
                    submitButton.disabled = false;
                } else {
                    await firestoreFunctions.addDoc(participantsRef, {
                        fullname: fullname,
                        pseudo: pseudo,
                        whatsapp: whatsapp,
                        pseudo_lower: pseudo.toLowerCase(),
                        createdAt: new Date()
                    });
                    displayMessage("Inscription réussie !", "success");
                    submitButton.textContent = 'INSCRIT !';
                }
            } catch (error) {
                console.error("Erreur avec Firestore: ", error);
                displayMessage("Une erreur est survenue. Veuillez réessayer.", "error");
                submitButton.textContent = "S'INSCRIRE";
                submitButton.disabled = false;
            }
        });

        function displayMessage(text, type) {
            messageArea.textContent = text;
            if (type) {
                messageArea.classList.add(type);
            }
        }
    </script>
</body>
</html>
